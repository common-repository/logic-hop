function logicHopConditionBuilder(){var o=this;this.json_vars={},this.condition_json,this.condition_count=0,this.condition_logic="and",this.condition_class="form-inline",this.condition_input_class="form-control",this.info_default={},this.post_types=[],this.terms=[],this.conditions={},this.condition_types=[],this.addVars=function(i,t){o.json_vars[i]=t},this.addPostType=function(i){o.post_types.push(i)},this.addPostTypes=function(){o.post_types.length>0&&Object.keys(o.conditions).forEach(function(i){o.conditions[i].inputs&&Object.keys(o.conditions[i].inputs).forEach(function(t){o.conditions[i].inputs[t].name.includes("page")&&o.conditions[i].inputs[t].source&&Array.prototype.push.apply(o.conditions[i].inputs[t].source,o.post_types)})})},this.addTerm=function(i){o.terms.push(i)},this.addTerms=function(){o.terms.length>0&&Object.keys(o.conditions).forEach(function(i){o.conditions[i].inputs&&Object.keys(o.conditions[i].inputs).forEach(function(t){void 0!==o.conditions[i].inputs[t].query&&o.conditions[i].inputs[t].query.includes("terms")&&o.conditions[i].inputs[t].source&&Array.prototype.push.apply(o.conditions[i].inputs[t].source,o.terms)})})},this.parseJSON=function(i){var t={};try{t=JSON.parse(i,function(i,t){if("string"==typeof t&&"vars:"==t.substring(0,5)){var n=t.substring(5);if(n in o.json_vars)return o.json_vars[n]}return t})}catch(o){}return t},this.setData=function(i){o.info_default=logichop_text.info_default,o.conditions=o.parseJSON(i),o.condition_types=Object.values(o.conditions).map(o=>o.category).filter((o,i,t)=>t.indexOf(o)===i).sort(),o.addPostTypes(),o.addTerms()},this.addCondition=function(i,t){o.conditions[i]=t},this.init=function(i){if(o.condition_count++,1==o.condition_count)var t=jQuery('<select class="'+o.condition_input_class+' logic"><option value="if">'+logichop_text.if+"</option></select>");else t=jQuery('<select class="'+o.condition_input_class+' logic"><option value="and">'+logichop_text.and+'</option><option value="or">'+logichop_text.or+"</option></select>");var n=jQuery('<select class="'+o.condition_input_class+' category"><option value="">'+logichop_text.category+"</option></select>");jQuery.each(o.condition_types,function(o,i){n.append(jQuery("<option></option>").attr("value",i).text(i))});var e="";i&&(e="loginchop-condition-set");var a='<a href="#" title="'+logichop_text.details+'" class="btn-info">'+logichop_text.details+'</a><div class="info"></div><a href="#" title="'+logichop_text.add_cond+'" class="btn-add button-secondary">+</a><a href="#" title="'+logichop_text.remove_cond+'" class="btn-remove"><small>'+logichop_text.remove_cond+"</small></a></div>",c=jQuery('<div class="'+o.condition_class+" logichop-condition "+e+'"><span class="params"></span>'+a);if(c.prepend(n),c.prepend(t),i){var s=o.conditions[i].category;n.val(s),this.displayType(c,s).val(i)}return jQuery(".logichop-conditions").append(c),o.updateLogic(o.condition_logic),c.children(".info").html(o.info_default),c},this.refresh=function(i){o.init(!1)},this.displayType=function(i,t){jQuery(i).find(".type").remove(),i.children(".params").html("");var n=jQuery('<select class="'+o.condition_input_class+' type"><option value="">'+logichop_text.select_type+"</option></select>");return jQuery.each(o.conditions,function(o,i){i.category==t&&n.append(jQuery("<option></option>").attr("value",o).text(i.label))}),n.insertAfter(i.find("select").last()),n},this.display=function(i,t,n){var e=i.children(".params"),a=o.conditions[t].inputs;e.html(""),jQuery.each(a,function(i,t){if("select"==t.type){var a=jQuery('<select class="'+o.condition_input_class+" "+t.name+'"></select>');"operator"!=t.name&&a.append(jQuery('<option value="">'+logichop_text.select+" "+t.label+"</option>")),jQuery.each(t.options,function(o,i){a.append(jQuery("<option></option>").attr("value",o).text(i))}),n&&a.val(n[t.name]),e.append(a)}else if("datalist"==t.type){var c=jQuery('<input class="datalist '+o.condition_input_class+" "+t.name+'" list="'+t.name+'">'),s=jQuery('<datalist id="'+t.name+'"></datalist>');if("operator"!=t.name&&s.append(jQuery('<option value="">'+logichop_text.select+" "+t.label+"</option>")),jQuery.each(t.options,function(o,i){s.append(jQuery("<option></option>").attr("value",i).attr("data-value",o))}),n){var l=s.find('[data-value="'+n[t.name]+'"]').attr("value");l?c.val(l):c.val(n[t.name])}e.append(c),e.append(s)}else if("ajax"==t.type){var p="",r="";n&&n[t.name]&&(p=n[t.name]),t.query||(t.query="posts");var d=""!=p?" logichop-ajax-loading":"",u='<form onsubmit="return false;" class="logichop-ajax-container">';u+='<input class="'+o.condition_input_class+" "+t.name+"_lookup logichop-ajax"+d+'" type="text" placeholder="'+t.label+'">',u+='<input class="'+t.name+' logichop-ajax-data" type="hidden" value="'+p+'">',u+="</form>";var h=jQuery(u);e.append(h);var f="."+t.name,g=f+"_lookup";""!=p&&jQuery.ajax({type:"POST",dataType:"json",url:logichop.ajaxurl,data:{action:"post_title_lookup",id:p,type:t.source,query:t.query},success:function(o){o.title?h.children(g).val(o.title).addClass("logichop-ajax-locked").data("title",o.title).removeClass("logichop-ajax-loading"):h.children(f).val("")}}),h.children(g).autoComplete({minChars:1,source:function(o,i){jQuery.ajax({type:"POST",dataType:"json",url:logichop.ajaxurl,data:{action:"post_lookup",lookup:o,type:t.source,query:t.query},success:function(o){i(o),h.children(g).removeClass("logichop-ajax-loading")}})},renderItem:function(o,i){return'<div class="autocomplete-suggestion" data-val="'+o.title+'" data-id="'+o.id+'">'+o.title+"</div>"},onSelect:function(o,i,t){h.children(g).val(i).addClass("logichop-ajax-locked").data("title",i),h.children(f).val(jQuery(t).data("id"))}}).on("keypress",function(){jQuery(this).addClass("logichop-ajax-loading")}).on("change",function(){jQuery(this).removeClass("logichop-ajax-loading"),jQuery(this).hasClass("logichop-ajax-locked")&&jQuery(this).data("title")!=jQuery(this).val()&&(jQuery(this).val("").removeClass("logichop-ajax-locked"),jQuery(this).siblings(f).val(""))})}else{p="",r="";"number"==t.type&&(p=1,r='min="0" step="1"'),"url"==t.name&&(p="http://"),n&&(n[t.name]||0===n[t.name])&&(p=n[t.name]);var y=t.placeholder?'placeholder="'+t.placeholder+'"':"";e.append(jQuery('<input class="'+o.condition_input_class+" "+t.name+'" type="'+t.type+'" value="'+p+'"'+r+" "+y+">"))}}),o.conditions[t].info&&i.children(".info").html(o.conditions[t].info)},this.formatJson=function(){var i,t,n=[];jQuery(".logichop-condition").each(function(t,e){var a=jQuery(this).find(".type").val();i=jQuery(this).find(".logic").val();var c=jQuery(this).find(".params");if(a){var s=o.conditions[a].map,l=[];if(jQuery.each(o.conditions[a].inputs,function(o,i){var t=c.find("."+i.name).val().replace(/([\\"])/g,"");if(c.find("."+i.name).hasClass("datalist")){var n=jQuery("#"+i.name).find('option[value="'+t+'"]').attr("data-value");n&&(t=n)}if(i.name.search("page-")<0){var e=new RegExp("#"+i.name,"g");s=s.replace(e,t)}else t&&l.unshift(parseInt(t))}),l){var p=new RegExp("#pages","g");s=s.replace(p,l)}n.push(s)}}),t="if"==i?n.toString():'{"'+i+'": ['+n.toString()+"]}",o.condition_json=t,jQuery(".output").html(o.condition_json)},this.parseData=function(i){var t,n=[],e=Object.keys(i);"and"==e[0]||"or"==e[0]?(n=i[e[0]],t=e[0]):n.push(i),jQuery.each(n,function(i,t){var n=Object.keys(t),e=[],a=JSON.stringify(t);e.operator=n[0],jQuery.each(o.conditions,function(o,i){if(a.search(i.lookup)>=0)return e.type=o,!1}),jQuery.each(o.conditions[e.type].inputs,function(i,n){if("operator"!=n.name)if("path"==e.type){var a=t[e.operator][0].compare_array_slice[0].pop();e[n.name]=a}else if("time_elapsed"==e.type){if("object"==typeof(s=t[e.operator][n.map])){var c=s["-"][1].var;e[n.name]=c.substr(c.indexOf(".")+1)}else e[n.name]=s}else{var s;if("object"==typeof(s=t[e.operator][n.map])){var l=o.conditions[e.type].type;o[l]&&"function"==typeof o[l]&&(e[n.name]=o[l](s))}else e[n.name]=s}});var c=o.init(e.type);o.display(c,e.type,e)}),t&&o.updateLogic(t),o.formatJson()},this.updateLogic=function(o){jQuery(".logic").each(function(){"if"!=jQuery(this).val()&&jQuery(this).val(o)})},this.saveCondition=function(){jQuery("#excerpt").html(this.condition_json)},this.valueKeyExists=function(o){try{return o.key_exists[0]}catch(o){return""}},this.valueInArray=function(o){try{return o.in[0]}catch(o){return""}},this.valueSubStrIndex=function(o){try{return o.var.substr(o.var.indexOf(".")+1)}catch(o){return""}},this.valueSubStrLastIndex=function(o){try{return o.var.substr(o.var.lastIndexOf(".")+1)}catch(o){return""}}}var logicHopCB=new logicHopConditionBuilder;jQuery(function(o){logichop.conditions?(logicHopCB.setData(logichop.conditions),logichop_data?logicHopCB.parseData(logichop_data):logicHopCB.init(!1)):o("#logichop-condition-builder-error").show(),o(".logichop-conditions").on("click",".btn-add",function(o){logicHopCB.init(!1),logicHopCB.saveCondition(),o.preventDefault()}),o("body").on("click",".btn-save",function(o){logicHopCB.saveCondition(),o.preventDefault()}),o("body").on("click",".logichop-condition-logic",function(i){o(".logichop-condition-excerpt").hasClass("logichop-condition-excerpt-hide")?(o(this).html(logichop_text.hide_logic),o(".logichop-condition-excerpt").removeClass("logichop-condition-excerpt-hide")):(o(this).html(logichop_text.show_logic),o(".logichop-condition-excerpt").addClass("logichop-condition-excerpt-hide")),i.preventDefault()}),o("body").on("click","#logichop_css_condition",function(i){o(".logichop-css").hasClass("logichop-condition-excerpt-hide")?o(".logichop-css").removeClass("logichop-condition-excerpt-hide"):o(".logichop-css").addClass("logichop-condition-excerpt-hide")}),o(".logichop-conditions").on("change",".category",function(){var i=o(this).val();i&&logicHopCB.displayType(o(this).parent(),i)}),o(".logichop-conditions").on("change",".type",function(){o(this).val()?(logicHopCB.display(o(this).parent(),o(this).val(),!1),o(this).parent().addClass("loginchop-condition-set")):o(this).parent().removeClass("loginchop-condition-set")}),o(".logichop-conditions").on("click",".btn-remove",function(i){o(this).parent().remove(),logicHopCB.condition_count--,"if"!=o(".logichop-condition").first().find(".logic").val()&&(o(".logichop-condition").first().find(".logic").empty(),o(".logichop-condition").first().find(".logic").append('<option value="if">'+logichop_text.if+"</option>")),0==logicHopCB.condition_count&&logicHopCB.init(),logicHopCB.formatJson(),logicHopCB.saveCondition(),i.preventDefault()}),o(".logichop-conditions").on("click",".btn-info",function(i){o(this).parent().find(".info").toggle(),i.preventDefault()}),o(".logichop-conditions").on("change",".logic",function(){logicHopCB.condition_logic=o(this).val(),logicHopCB.updateLogic(logicHopCB.condition_logic),logicHopCB.saveCondition()}),o(".logichop-conditions").on("change keyup","input, select",function(){logicHopCB.formatJson(),logicHopCB.saveCondition()})});